name: Continuous Delivery (CD) - Budget Tracker App

on:
  push:
    branches:
      - main
    paths:
      - 'BudgetTracker/**' 
      - 'ansible/**'

# CRITICAL FIX: The 'permissions' block MUST be flush left (zero spaces)
permissions:
  contents: read
  secrets: read 

jobs:
  # ====================================================================
  # JOB 1: BUILD & PUSH DOCKER IMAGE
  # ====================================================================
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./BudgetTracker 
          push: true
          tags: |
            gheorghi99/minimal-budget-tracker:${{ github.sha }} 
            gheorghi99/minimal-budget-tracker:latest
            
  # ====================================================================
  # JOB 2: DEPLOY VIA ANSIBLE
  # ====================================================================
  deploy-app:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    env:
      DROPLET_IP: 64.225.24.134 
      IMAGE_TAG: ${{ github.sha }}
      ANSIBLE_HOST_KEY_CHECKING: no
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # --- 1. Setup SSH Agent ---
      - name: Setup SSH Agent and Add Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} 
          
      - name: Add Droplet Host Key to known_hosts
        run: ssh-keyscan -H ${{ env.DROPLET_IP }} >> ~/.ssh/known_hosts

      # --- 2. Setup Ansible ---
      - name: Install Ansible and Collections
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible
          ansible-galaxy collection install community.docker

      # --- 3. Run Deployment ---
      - name: Create Dynamic Ansible Inventory
        run: |
          echo "[webservers]" > ansible/inventory.ini
          echo "${{ env.DROPLET_IP }} ansible_user=root" >> ansible/inventory.ini
        
      - name: Run Ansible Playbook (Deploy Updated Docker App)
        run: ansible-playbook -i ansible/inventory.ini ansible/deploy_docker.yml -e "DOCKER_IMAGE_TAG=${{ env.IMAGE_TAG }}"
