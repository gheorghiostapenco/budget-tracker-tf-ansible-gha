- name: Setup Docker and Run Application Container
  hosts: webservers
  become: yes
  environment:
    # Ensure noninteractive mode for apt tasks
    DEBIAN_FRONTEND: noninteractive

  vars:
    # FIX: Use the Ansible extra-var DOCKER_IMAGE_TAG passed from GitHub Actions
    DOCKER_IMAGE_TAG: "{{ DOCKER_IMAGE_TAG }}"
    DOCKER_IMAGE_NAME: gheorghi99/minimal-budget-tracker:{{ DOCKER_IMAGE_TAG }}
    HOST_PORT: 80 
    CONTAINER_PORT: 5000
    # Change to jammy if you're on Ubuntu 22.04
    UBUNTU_CODENAME: focal

  tasks:
    # ... (Prerequisite tasks for installing Docker are kept the same)
    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - python3-pip
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ UBUNTU_CODENAME }} stable"
        state: present

    - name: Install Docker
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes

    - name: Ensure Docker service is enabled and started
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    # --- Container Deployment Tasks ---
    
    - name: Install Docker Python module
      # This pip module installation should happen *before* tasks that use community.docker modules
      ansible.builtin.pip:
        name: docker
        executable: pip3

    - name: Pull Docker image (Tag: {{ DOCKER_IMAGE_TAG }})
      community.docker.docker_image:
        # Use the correctly templated variable
        name: "{{ DOCKER_IMAGE_NAME }}"
        source: pull

    - name: Run container
      community.docker.docker_container:
        # Use the base image name without the tag for the container name
        name: minimal-budget-tracker
        image: "{{ DOCKER_IMAGE_NAME }}"
        restart_policy: always
        # Ensure the container is re-created for new image deployment
        recreate: yes
        ports:
          - "{{ HOST_PORT }}:{{ CONTAINER_PORT }}"