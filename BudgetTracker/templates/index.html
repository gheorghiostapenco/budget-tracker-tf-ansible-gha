<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Budget Tracker - Tailwind</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for transaction types */
        .income {
            color: #10B981; /* Tailwind green-500 */
            font-weight: 600;
        }
        .expense {
            color: #EF4444; /* Tailwind red-500 */
        }
        /* Style for the reset button */
        #resetButton {
            @apply bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md hover:bg-red-700 transition-colors duration-200;
        }
        /* Style for the transaction list items */
        .income-bg { background-color: #ECFDF5; } /* Tailwind green-50 */
        .expense-bg { background-color: #FEF2F2; } /* Tailwind red-50 */
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal p-4">
    <div class="container mx-auto bg-white shadow-lg rounded-lg p-6 max-w-2xl mt-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Minimal Budget Tracker</h1>
        
        <div class="mb-8 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="md:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Remaining Budget: 
                    <span id="currentBudget" class="text-blue-600 text-2xl font-extrabold">$0.00</span>
                </h2>
                <h2 class="text-xl font-semibold text-gray-700">Monthly Limit: 
                    <span id="monthlyBudgetLimit" class="text-purple-600 text-2xl font-extrabold">$0.00</span>
                </h2>
            </div>
            
            <div class="md:col-span-1 border-t md:border-t-0 md:border-l border-gray-300 pt-4 md:pt-0 md:pl-4">
                <h3 class="text-lg font-medium text-gray-600 mb-2">Set Budget Limit</h3>
                <form id="budgetForm">
                    <input type="number" step="0.01" id="budgetAmount" name="amount" required 
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2"
                           placeholder="Limit Amount">
                    <button type="submit" 
                            class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-md shadow-md focus:outline-none focus:shadow-outline transition-colors duration-200 w-full text-sm">
                        Set Limit
                    </button>
                </form>
            </div>
            
            <div class="md:col-span-3">
                <hr class="my-4 border-gray-300">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">Expense Statistics:</h3>
                        <ul id="expenseStatsList" class="list-disc list-inside text-gray-700">
                            </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-green-600 mb-2">Income Statistics:</h3>
                        <ul id="incomeStatsList" class="list-disc list-inside text-gray-700">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-6 border-gray-300">
        
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add Transaction</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="md:col-span-1">
                <label for="amount" class="block text-gray-700 text-sm font-bold mb-2">Amount:</label>
                <input type="number" step="0.01" id="amount" name="amount" required 
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                       placeholder="e.g., 25.50">
            </div>
            
            <div class="md:col-span-1">
                <label for="category" class="block text-gray-700 text-sm font-bold mb-2">Category (Expense):</label>
                <select id="category" name="category" 
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="Food">Food</option>
                    <option value="Health">Health</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Home">Home</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="md:col-span-2">
                <label for="description" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                <input type="text" id="description" name="description"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                       placeholder="Optional description">
            </div>
            
            <div class="md:col-span-4 grid grid-cols-2 gap-4">
                <button type="button" id="addExpenseBtn" 
                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline transition-colors duration-200 w-full">
                    Add Expense
                </button>
                <button type="button" id="addIncomeBtn" 
                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline transition-colors duration-200 w-full">
                    Add Income
                </button>
            </div>
        </div>
        
        <hr class="my-6 border-gray-300">
        
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
        <ul id="transactionsList" class="space-y-2">
            </ul>
        
        <hr class="my-6 border-gray-300">
        
        <button id="resetButton" class="w-full">
            Reset All Data
        </button>
    </div>

<script>
        // API Endpoints
        const API_URL = '/api/transactions';
        const RESET_URL = '/api/reset';
        const BUDGET_URL = '/api/budget';
        
        // Category lists (must match backend)
        const expenseCategories = ["Food", "Health", "Transportation", "Home", "Other"];
        const incomeCategories = ["Salary", "Freelance", "Other"];
        
        // --- Core Logic Functions ---

        // ---------------------------------------------------------------------
        // FIX 1: Create a dedicated function to update all UI elements
        // This function will be called by *all* other functions that get new data.
        // ---------------------------------------------------------------------
        function updateUI(data) {
            // 1. Update Remaining Budget and Limit displays
            document.getElementById('currentBudget').textContent = `$${data.current_budget.toFixed(2)}`;
            document.getElementById('monthlyBudgetLimit').textContent = `$${data.monthly_budget.toFixed(2)}`;
            
            // 2. Render Transactions History
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = ''; 
            
            data.transactions.slice().reverse().forEach(t => {
                const li = document.createElement('li');
                const className = t.type; 
                const categoryText = `(${t.category || 'Other'})`;
                
                li.className = `p-3 rounded-md shadow-sm flex justify-between items-center ${className}-bg ${className}`;
                li.innerHTML = `
                    <span class="text-gray-800">${t.description || 'Transaction'} ${categoryText}</span>
                    <span class="${className === 'income' ? 'text-green-600' : 'text-red-600'} font-semibold">$${t.amount.toFixed(2)}</span>
                `;
                transactionsList.appendChild(li);
            });

            // 3. Render Expense Statistics
            const expenseStatsList = document.getElementById('expenseStatsList');
            expenseStatsList.innerHTML = '';
            expenseCategories.forEach(cat => {
                const amount = data.expense_stats[cat] || 0.00; 
                if (amount > 0) {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 mb-1';
                    li.textContent = `${cat}: $${amount.toFixed(2)}`;
                    expenseStatsList.appendChild(li);
                }
            });

            // 4. Render Income Statistics
            const incomeStatsList = document.getElementById('incomeStatsList');
            incomeStatsList.innerHTML = '';
            incomeCategories.forEach(cat => {
                const amount = data.income_stats[cat] || 0.00;
                if (amount > 0) {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 mb-1';
                    li.textContent = `${cat}: $${amount.toFixed(2)}`;
                    incomeStatsList.appendChild(li);
                }
            });
        }
        
        // ---------------------------------------------------------------------
        // FIX 2: Refactor fetchData() to only fetch and call updateUI()
        // ---------------------------------------------------------------------
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error("Server error while fetching data.");
                }
                const data = await response.json();
                updateUI(data); // Call the new UI update function
            } catch (error) {
                console.error("fetchData error:", error);
                alert("Error fetching data from server.");
            }
        }
        
        // --- Transaction Input Logic ---
        
        // This function is correct. It POSTs data and then calls fetchData()
        // to get the new state, which is required because the POST response
        // for transactions does not include the full state.
        async function postTransaction(transactionData) {
            if (transactionData.amount <= 0 || isNaN(transactionData.amount)) {
                 alert('Amount must be a positive number.');
                 return;
            }

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(transactionData)
            });
            
            if (response.ok) {
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                document.getElementById('category').value = 'Food';
                fetchData(); // This is correct: get the new state
            } else {
                const errorData = await response.json();
                alert(`Error adding transaction: ${errorData.error}`);
            }
        }

        // Add Expense Button
        document.getElementById('addExpenseBtn').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value || 'Expense';
            const category = document.getElementById('category').value;
            
            const newTransaction = {
                amount: amount, type: 'expense', 
                category: category, description: description
            };
            postTransaction(newTransaction);
        });

        // Add Income Button
        document.getElementById('addIncomeBtn').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value || 'Income'; 
            const category = 'Other'; // Default to 'Other'
            
            const newTransaction = {
                amount: amount, type: 'income', 
                category: category, description: description
            };
            postTransaction(newTransaction);
        });
        
        // --- Other Form Handlers (Budget, Reset) ---

        // ---------------------------------------------------------------------
        // FIX 3: Refactor budgetForm handler to use the data from its
        // *own response* instead of calling fetchData().
        // ---------------------------------------------------------------------
        document.getElementById('budgetForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const amountValue = parseFloat(form.amount.value);
            
            if (isNaN(amountValue) || amountValue < 0) {
                alert('Please enter a valid non-negative budget amount.');
                return;
            }

            const newBudget = { amount: amountValue };
            
            try {
                const response = await fetch(BUDGET_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newBudget)
                });
                
                if (response.ok) {
                    form.reset();
                    // Get the new state *directly* from the POST response
                    const data = await response.json(); 
                    // Call the UI update function with the fresh data
                    updateUI(data); 
                } else {
                    const errorData = await response.json();
                    alert(`Error setting budget: ${errorData.error}`);
                }
            } catch (error) {
                console.error("setBudget error:", error);
                alert("Error setting budget.");
            }
        });

        // Reset Button
        document.getElementById('resetButton').addEventListener('click', async () => {
            if (confirm('Are you sure you want to reset ALL data? This action cannot be undone.')) {
                const response = await fetch(RESET_URL, { method: 'POST' });
                if (response.ok) {
                    alert('Data successfully reset!');
                    fetchData(); // Correct: get the new (empty) state
                } else {
                    alert('Error resetting data.');
                }
            }
        });

        // Initial data load on page load
        fetchData();
    </script>
</body>
</html>
